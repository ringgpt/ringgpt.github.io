import{f as C,s as F,n as z,o as oe,h as re,b as ee,r as ae,i as j}from"../chunks/scheduler.3578c530.js";import{S as G,i as K,g as w,s as B,h as N,j as S,y as P,c as V,f as m,k as v,a as I,x as k,z as O,e as H,d as E,p as ie,t as D,b as ce,r as Q,u as X,v as Y,w as Z,m as te,n as ne}from"../chunks/index.bafd8785.js";import{w as he}from"../chunks/paths.a10e885e.js";function L(s,e){var t;{if(typeof e=="string")t=localStorage[s]??e;else{let l=JSON.stringify(e),r=localStorage[s];r==="undefined"&&(localStorage[s]=l,r=l),t=JSON.parse(r??l)}e instanceof Date&&(t=new Date(t))}const n=he(t);return n.subscribe(l=>{typeof l=="string"?localStorage[s]=l:localStorage[s]=JSON.stringify(l)}),n}const pe=L("useserver",!1),R=L("openaikey","");if(C(R)==""){let s=prompt("please enter your openai key");s!=null&&R.set(s)}const ge=L("messagecount",0);let A={};localStorage.getItem("message_0")||(x({role:"assistant",content:"how can I help you?"},null),x({role:"user",content:"explain quantum computing for a five year old"},0),x({role:"user",content:'say "I love you" in binary'},0),x({role:"user",content:"show me a quine in python"},0),x({role:"user",content:"..."},0));function T(s){return A[s]||(A[s]=L(`message_${s}`,{message:{role:"assistant",content:"how can I help you?"},children:[],parent:null})),A[s]}function x(s,e){let t=0;ge.update(l=>(t=l,l+1)),console.log("creating ",t);let n=T(t);return n==null||n.set({message:s,children:[],parent:e}),e!=null&&T(e).update(r=>({...r,children:[t,...r.children]})),t}function W(s){if(s==0)return;let e=C(T(s));if(e.parent==0&&C(T(0)).children.length==1&&x({role:"user",content:""},0),console.log("deleting ",s),e.parent!=null){let t=T(e.parent);t.update(n=>({...n,children:n.children.filter(l=>l!=s)})),console.log("parent ",C(t))}e.children.forEach(t=>{W(t)}),localStorage.removeItem(`message_${s}`),delete A[s]}async function me(s,e){return(await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e},body:JSON.stringify({model:"gpt-3.5-turbo",messages:s.messages,temperature:s.temperature??.7,stream:!0})})).body}async function _e(s,e){let t;if(C(pe)){let o=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(o.body==null||o.body==null)return console.error("failed to get response stream"),"";t=o.body.getReader()}else t=(await me(s,C(R))).getReader();let n=new TextDecoder,l="",r=!1;for(;!r;){const{value:o,done:c}=await t.read();r=c,n.decode(o).split(`
`).filter(a=>a.length>0).forEach(a=>{if(a=="data: [DONE]")return l;if(!a.startsWith("data:"))throw console.error("unexpected response",a),new Error("unexpected response");let h=JSON.parse(a.slice(6));h.choices[0].delta.content&&(l+=h.choices[0].delta.content,e==null||e(l))})}return l}function be(s){let e,t;return{c(){e=w("div"),t=w("div"),this.h()},l(n){e=N(n,"DIV",{class:!0});var l=S(e);t=N(l,"DIV",{class:!0}),S(t).forEach(m),l.forEach(m),this.h()},h(){v(t,"class","msg svelte-z15wxn"),v(e,"class","assistant svelte-z15wxn")},m(n,l){I(n,e,l),k(e,t),s[13](t)},p:z,d(n){n&&m(e),s[13](null)}}}function ve(s){let e,t,n,l,r="x",o,c;return{c(){e=w("div"),t=w("div"),n=B(),l=w("button"),l.textContent=r,this.h()},l(u){e=N(u,"DIV",{class:!0});var d=S(e);t=N(d,"DIV",{contenteditable:!0,class:!0}),S(t).forEach(m),n=V(d),l=N(d,"BUTTON",{class:!0,"data-svelte-h":!0}),P(l)!=="svelte-1n9arnn"&&(l.textContent=r),d.forEach(m),this.h()},h(){v(t,"contenteditable",""),v(t,"class","msg svelte-z15wxn"),v(l,"class","active svelte-z15wxn"),v(e,"class","user svelte-z15wxn")},m(u,d){I(u,e,d),k(e,t),s[11](t),k(e,n),k(e,l),o||(c=[O(t,"keypress",s[4]),O(t,"keyup",s[6]),O(t,"keydown",s[5]),O(t,"input",s[7]),O(t,"paste",we),O(l,"click",s[12])],o=!0)},p:z,d(u){u&&m(e),s[11](null),o=!1,ae(c)}}}function ye(s){let e,t,n="Â ",l,r,o,c="x",u,d;function a(_,b){return _[2].message.role=="user"?ve:be}let h=a(s),p=h(s);return{c(){e=w("div"),t=w("button"),t.textContent=n,l=B(),p.c(),r=B(),o=w("button"),o.textContent=c,this.h()},l(_){e=N(_,"DIV",{class:!0});var b=S(e);t=N(b,"BUTTON",{class:!0,"data-svelte-h":!0}),P(t)!=="svelte-2nj3z4"&&(t.textContent=n),l=V(b),p.l(b),r=V(b),o=N(b,"BUTTON",{class:!0,"data-svelte-h":!0}),P(o)!=="svelte-1fkcjn"&&(o.textContent=c),b.forEach(m),this.h()},h(){v(t,"class","svelte-z15wxn"),v(o,"class","active svelte-z15wxn"),v(e,"class","bubble svelte-z15wxn")},m(_,b){I(_,e,b),k(e,t),k(e,l),p.m(e,null),k(e,r),k(e,o),u||(d=O(o,"click",s[14]),u=!0)},p(_,[b]){h===(h=a(_))&&p?p.p(_,b):(p.d(1),p=h(_),p&&(p.c(),p.m(e,r)))},i:z,o:z,d(_){_&&m(e),p.d(),u=!1,d()}}}function q(s){let e=s.replaceAll("<","&lt;").replace(/\n/g,"<br>");for(var t=0;;){let n=e.indexOf("```",t);if(n==-1)break;let l=e.indexOf("<br>",n+1),r=e.substring(n+3,l);if(t=e.indexOf("```",l),t==-1)break;let o=e.substring(l+4,t),c=o.replaceAll('"','\\"').replaceAll("<br>",`
`),u=`<pre class="codeblock"><div> ${r} <button onclick='navigator.clipboard.writeText(\`${c}\`)'>copy</button> </div>`+o+"</pre>";e=e.substring(0,n)+u+e.substring(t+3)}return e}function ke(s){return s.replace(/<br>/g,`
`)}function ue(s){let e=document.createElement("textarea");return e.innerHTML=s,e.remove(),e.value}function we(s){var t;s.preventDefault(),console.log("paste");let e=(t=s.clipboardData)==null?void 0:t.getData("text/plain");e&&document.execCommand("insertText",!1,e)}function Ne(s,e,t){let n,l=z,r=()=>(l(),l=re(d,f=>t(2,n=f)),d);s.$$.on_destroy.push(()=>l());let{id:o}=e,c=o,{sendMessage:u}=e,d=T(o);r();let a;oe(()=>{t(1,a.innerHTML=q(n.message.content),a)});let h=!1;function p(f){f.key=="Enter"&&!h&&(f.preventDefault(),u())}function _(f){f.key=="Shift"&&(h=!0)}function b(f){f.key=="Shift"&&(h=!1)}function i(f){let U=ke(a.innerHTML),fe=n.message.content;n.children.length>0?(x({role:"user",content:U},n.parent),t(1,a.innerHTML=q(fe),a),console.log("create new node",U)):d.update($=>($.message.content=U,$))}function g(f){ee[f?"unshift":"push"](()=>{a=f,t(1,a),t(0,o),t(2,n),t(10,c)})}const y=()=>{W(o)};function J(f){ee[f?"unshift":"push"](()=>{a=f,t(1,a),t(0,o),t(2,n),t(10,c)})}const M=()=>{W(o)};return s.$$set=f=>{"id"in f&&t(0,o=f.id),"sendMessage"in f&&t(8,u=f.sendMessage)},s.$$.update=()=>{s.$$.dirty&1031&&(r(t(3,d=T(o))),a&&(n.message.role!="user"||c!=o)&&(t(1,a.innerHTML=q(n.message.content),a),t(10,c=o)))},[o,a,n,d,p,_,b,i,u,ue,c,g,y,J,M]}class Te extends G{constructor(e){super(),K(this,e,Ne,ye,F,{id:0,sendMessage:8,cleanMarkup:9})}get cleanMarkup(){return ue}}function se(s){let e,t,n,l;e=new Te({props:{id:s[0],sendMessage:s[4]}});let r=s[1].children.length>0&&le(s);return{c(){Q(e.$$.fragment),t=B(),r&&r.c(),n=H()},l(o){X(e.$$.fragment,o),t=V(o),r&&r.l(o),n=H()},m(o,c){Y(e,o,c),I(o,t,c),r&&r.m(o,c),I(o,n,c),l=!0},p(o,c){const u={};c&1&&(u.id=o[0]),e.$set(u),o[1].children.length>0?r?(r.p(o,c),c&2&&E(r,1)):(r=le(o),r.c(),E(r,1),r.m(n.parentNode,n)):r&&(ie(),D(r,1,1,()=>{r=null}),ce())},i(o){l||(E(e.$$.fragment,o),E(r),l=!0)},o(o){D(e.$$.fragment,o),D(r),l=!1},d(o){o&&(m(t),m(n)),Z(e,o),r&&r.d(o)}}}function le(s){let e,t,n,l,r,o,c,u,d,a,h,p,_,b;return h=new de({props:{nodeId:s[1].children[s[3]]}}),{c(){e=w("div"),t=w("button"),n=te("<"),r=B(),o=w("button"),c=te(">"),d=B(),a=w("div"),Q(h.$$.fragment),this.h()},l(i){e=N(i,"DIV",{class:!0});var g=S(e);t=N(g,"BUTTON",{class:!0});var y=S(t);n=ne(y,"<"),y.forEach(m),r=V(g),o=N(g,"BUTTON",{class:!0});var J=S(o);c=ne(J,">"),J.forEach(m),g.forEach(m),d=V(i),a=N(i,"DIV",{});var M=S(a);X(h.$$.fragment,M),M.forEach(m),this.h()},h(){v(t,"class",l=j(s[3]>0?"active":"hidden")+" svelte-1usy634"),v(o,"class",u=j(s[1].children.length>s[3]+1?"active":"hidden")+" svelte-1usy634"),v(e,"class","navbar svelte-1usy634")},m(i,g){I(i,e,g),k(e,t),k(t,n),k(e,r),k(e,o),k(o,c),I(i,d,g),I(i,a,g),Y(h,a,null),p=!0,_||(b=[O(t,"click",s[6]),O(o,"click",s[7])],_=!0)},p(i,g){(!p||g&8&&l!==(l=j(i[3]>0?"active":"hidden")+" svelte-1usy634"))&&v(t,"class",l),(!p||g&10&&u!==(u=j(i[1].children.length>i[3]+1?"active":"hidden")+" svelte-1usy634"))&&v(o,"class",u);const y={};g&10&&(y.nodeId=i[1].children[i[3]]),h.$set(y)},i(i){p||(E(h.$$.fragment,i),p=!0)},o(i){D(h.$$.fragment,i),p=!1},d(i){i&&(m(e),m(d),m(a)),Z(h),_=!1,ae(b)}}}function Se(s){let e,t,n=s[1]&&se(s);return{c(){n&&n.c(),e=H()},l(l){n&&n.l(l),e=H()},m(l,r){n&&n.m(l,r),I(l,e,r),t=!0},p(l,[r]){l[1]?n?(n.p(l,r),r&2&&E(n,1)):(n=se(l),n.c(),E(n,1),n.m(e.parentNode,e)):n&&(ie(),D(n,1,1,()=>{n=null}),ce())},i(l){t||(E(n),t=!0)},o(l){D(n),t=!1},d(l){l&&m(e),n&&n.d(l)}}}function Ie(s,e,t){let n,l=z,r=()=>(l(),l=re(c,i=>t(1,n=i)),c);s.$$.on_destroy.push(()=>l());let{nodeId:o}=e,c=T(o);r();let u=n?n.children.length:0;var d=o;let a=0;function h(){console.log("get history");let i=[n.message],g=n.parent;for(;g!=null;){let y=T(g);i=[C(y).message,...i],g=C(y).parent}return console.log(i),i}async function p(){console.log("send");let i=h(),g=x({role:"assistant",content:""},o);x({role:"user",content:""},g);let y=T(g),J=await _e({messages:i},M=>y.update(f=>({...f,message:{...f.message,content:M}})));y.update(M=>({...M,message:{...M.message,content:J}}))}oe(()=>{c.subscribe(i=>{i.children.length>u?(t(3,a=0),console.log("child added"),u=i.children.length):i.children.length<u&&(console.log("child removed"),t(3,a=Math.max(0,a-1)),u=i.children.length)})});const _=()=>{t(3,a=Math.max(0,a-1))},b=()=>{t(3,a=Math.min(n.children.length-1,a+1))};return s.$$set=i=>{"nodeId"in i&&t(0,o=i.nodeId)},s.$$.update=()=>{s.$$.dirty&35&&o!=d&&(r(t(2,c=T(o))),t(5,d=o),u=n.children.length,t(3,a=0))},[o,n,c,a,p,d,_,b]}class de extends G{constructor(e){super(),K(this,e,Ie,Se,F,{nodeId:0})}}function Me(s){let e,t,n;return t=new de({props:{nodeId:0}}),{c(){e=w("main"),Q(t.$$.fragment),this.h()},l(l){e=N(l,"MAIN",{class:!0});var r=S(e);X(t.$$.fragment,r),r.forEach(m),this.h()},h(){v(e,"class","svelte-eolhps")},m(l,r){I(l,e,r),Y(t,e,null),n=!0},p:z,i(l){n||(E(t.$$.fragment,l),n=!0)},o(l){D(t.$$.fragment,l),n=!1},d(l){l&&m(e),Z(t)}}}class Ce extends G{constructor(e){super(),K(this,e,null,Me,F,{})}}export{Ce as component};
