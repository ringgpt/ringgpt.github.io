import{f as C,s as F,n as z,o as oe,h as re,b as ee,r as ae,i as j}from"../chunks/scheduler.3578c530.js";import{S as G,i as K,g as w,s as B,h as N,j as T,y as R,c as V,f as m,k as v,a as I,x as k,z as O,e as L,d as E,p as ie,t as D,b as ce,r as Q,u as X,v as Y,w as Z,m as te,n as ne}from"../chunks/index.bafd8785.js";import{w as he}from"../chunks/paths.9af81f61.js";function U(s,t){var e;{if(typeof t=="string")e=localStorage[s]??t;else{let l=JSON.stringify(t),r=localStorage[s];r==="undefined"&&(localStorage[s]=l,r=l),e=JSON.parse(r??l)}t instanceof Date&&(e=new Date(e))}const n=he(e);return n.subscribe(l=>{typeof l=="string"?localStorage[s]=l:localStorage[s]=JSON.stringify(l)}),n}const pe=U("useserver",!1),A=U("openaikey","");if(C(A)==""){let s=prompt("please enter your openai key");s!=null&&A.set(s)}const ge=U("messagecount",0);let H={};localStorage.getItem("message_0")||(x({role:"assistant",content:"how can I help you?"},null),x({role:"user",content:"explain quantum computing for a five year old"},0),x({role:"user",content:'say "I love you" in binary'},0),x({role:"user",content:"show me a quine in python"},0),x({role:"user",content:"..."},0));function S(s){return H[s]||(H[s]=U(`message_${s}`,{message:{role:"assistant",content:"how can I help you?"},children:[],parent:null})),H[s]}function x(s,t){let e=0;ge.update(l=>(e=l,l+1)),console.log("creating ",e);let n=S(e);return n==null||n.set({message:s,children:[],parent:t}),t!=null&&S(t).update(r=>({...r,children:[e,...r.children]})),e}function W(s){if(s==0)return;let t=C(S(s));if(t.parent==0&&C(S(0)).children.length==1&&x({role:"user",content:""},0),console.log("deleting ",s),t.parent!=null){let e=S(t.parent);e.update(n=>({...n,children:n.children.filter(l=>l!=s)})),console.log("parent ",C(e))}t.children.forEach(e=>{W(e)}),localStorage.removeItem(`message_${s}`),delete H[s]}async function me(s,t){return(await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+t},body:JSON.stringify({model:"gpt-3.5-turbo",messages:s.messages,temperature:s.temperature??.7,stream:!0})})).body}async function _e(s,t){let e;if(C(pe)){let o=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(o.body==null||o.body==null)return console.error("failed to get response stream"),"";e=o.body.getReader()}else e=(await me(s,C(A))).getReader();let n=new TextDecoder,l="",r=!1;for(;!r;){const{value:o,done:c}=await e.read();r=c,n.decode(o).split(`
`).filter(a=>a.length>0).forEach(a=>{if(a=="data: [DONE]")return l;if(!a.startsWith("data:"))throw console.error("unexpected response",a),new Error("unexpected response");let h=JSON.parse(a.slice(6));h.choices[0].delta.content&&(l+=h.choices[0].delta.content,t==null||t(l))})}return l}function be(s){let t,e;return{c(){t=w("div"),e=w("div"),this.h()},l(n){t=N(n,"DIV",{class:!0});var l=T(t);e=N(l,"DIV",{class:!0}),T(e).forEach(m),l.forEach(m),this.h()},h(){v(e,"class","msg svelte-z15wxn"),v(t,"class","assistant svelte-z15wxn")},m(n,l){I(n,t,l),k(t,e),s[13](e)},p:z,d(n){n&&m(t),s[13](null)}}}function ve(s){let t,e,n,l,r="x",o,c;return{c(){t=w("div"),e=w("div"),n=B(),l=w("button"),l.textContent=r,this.h()},l(u){t=N(u,"DIV",{class:!0});var d=T(t);e=N(d,"DIV",{contenteditable:!0,class:!0}),T(e).forEach(m),n=V(d),l=N(d,"BUTTON",{class:!0,"data-svelte-h":!0}),R(l)!=="svelte-1n9arnn"&&(l.textContent=r),d.forEach(m),this.h()},h(){v(e,"contenteditable",""),v(e,"class","msg svelte-z15wxn"),v(l,"class","active svelte-z15wxn"),v(t,"class","user svelte-z15wxn")},m(u,d){I(u,t,d),k(t,e),s[11](e),k(t,n),k(t,l),o||(c=[O(e,"keypress",s[4]),O(e,"keyup",s[6]),O(e,"keydown",s[5]),O(e,"input",s[7]),O(e,"paste",we),O(l,"click",s[12])],o=!0)},p:z,d(u){u&&m(t),s[11](null),o=!1,ae(c)}}}function ye(s){let t,e,n="Â ",l,r,o,c="x",u,d;function a(_,b){return _[2].message.role=="user"?ve:be}let h=a(s),p=h(s);return{c(){t=w("div"),e=w("button"),e.textContent=n,l=B(),p.c(),r=B(),o=w("button"),o.textContent=c,this.h()},l(_){t=N(_,"DIV",{class:!0});var b=T(t);e=N(b,"BUTTON",{class:!0,"data-svelte-h":!0}),R(e)!=="svelte-2nj3z4"&&(e.textContent=n),l=V(b),p.l(b),r=V(b),o=N(b,"BUTTON",{class:!0,"data-svelte-h":!0}),R(o)!=="svelte-1fkcjn"&&(o.textContent=c),b.forEach(m),this.h()},h(){v(e,"class","svelte-z15wxn"),v(o,"class","active svelte-z15wxn"),v(t,"class","bubble svelte-z15wxn")},m(_,b){I(_,t,b),k(t,e),k(t,l),p.m(t,null),k(t,r),k(t,o),u||(d=O(o,"click",s[14]),u=!0)},p(_,[b]){h===(h=a(_))&&p?p.p(_,b):(p.d(1),p=h(_),p&&(p.c(),p.m(t,r)))},i:z,o:z,d(_){_&&m(t),p.d(),u=!1,d()}}}function P(s){let t=s.replace(/\n/g,"<br>");for(var e=0;;){let n=t.indexOf("```",e);if(e=t.indexOf("```",n+1),e==-1)break;t=t.substring(0,n)+"<pre style='background:black;margin:10px;padding:10px;border-radius:10px'>"+t.substring(n+3,e)+"</pre>"+t.substring(e+3),console.log(t)}return t}function ke(s){return s.replace(/<br>/g,`
`)}function ue(s){let t=document.createElement("textarea");return t.innerHTML=s,t.remove(),t.value}function we(s){var e;s.preventDefault(),console.log("paste");let t=(e=s.clipboardData)==null?void 0:e.getData("text/plain");t&&document.execCommand("insertText",!1,t)}function Ne(s,t,e){let n,l=z,r=()=>(l(),l=re(d,f=>e(2,n=f)),d);s.$$.on_destroy.push(()=>l());let{id:o}=t,c=o,{sendMessage:u}=t,d=S(o);r();let a;oe(()=>{e(1,a.innerHTML=P(n.message.content),a)});let h=!1;function p(f){f.key=="Enter"&&!h&&(f.preventDefault(),u())}function _(f){f.key=="Shift"&&(h=!0)}function b(f){f.key=="Shift"&&(h=!1)}function i(f){let q=ke(a.innerHTML),fe=n.message.content;n.children.length>0?(x({role:"user",content:q},n.parent),e(1,a.innerHTML=P(fe),a),console.log("create new node",q)):d.update($=>($.message.content=q,$))}function g(f){ee[f?"unshift":"push"](()=>{a=f,e(1,a),e(0,o),e(2,n),e(10,c)})}const y=()=>{W(o)};function J(f){ee[f?"unshift":"push"](()=>{a=f,e(1,a),e(0,o),e(2,n),e(10,c)})}const M=()=>{W(o)};return s.$$set=f=>{"id"in f&&e(0,o=f.id),"sendMessage"in f&&e(8,u=f.sendMessage)},s.$$.update=()=>{s.$$.dirty&1031&&(r(e(3,d=S(o))),a&&(n.message.role!="user"||c!=o)&&(e(1,a.innerHTML=P(n.message.content),a),e(10,c=o)))},[o,a,n,d,p,_,b,i,u,ue,c,g,y,J,M]}class Se extends G{constructor(t){super(),K(this,t,Ne,ye,F,{id:0,sendMessage:8,cleanMarkup:9})}get cleanMarkup(){return ue}}function se(s){let t,e,n,l;t=new Se({props:{id:s[0],sendMessage:s[4]}});let r=s[1].children.length>0&&le(s);return{c(){Q(t.$$.fragment),e=B(),r&&r.c(),n=L()},l(o){X(t.$$.fragment,o),e=V(o),r&&r.l(o),n=L()},m(o,c){Y(t,o,c),I(o,e,c),r&&r.m(o,c),I(o,n,c),l=!0},p(o,c){const u={};c&1&&(u.id=o[0]),t.$set(u),o[1].children.length>0?r?(r.p(o,c),c&2&&E(r,1)):(r=le(o),r.c(),E(r,1),r.m(n.parentNode,n)):r&&(ie(),D(r,1,1,()=>{r=null}),ce())},i(o){l||(E(t.$$.fragment,o),E(r),l=!0)},o(o){D(t.$$.fragment,o),D(r),l=!1},d(o){o&&(m(e),m(n)),Z(t,o),r&&r.d(o)}}}function le(s){let t,e,n,l,r,o,c,u,d,a,h,p,_,b;return h=new de({props:{nodeId:s[1].children[s[3]]}}),{c(){t=w("div"),e=w("button"),n=te("<"),r=B(),o=w("button"),c=te(">"),d=B(),a=w("div"),Q(h.$$.fragment),this.h()},l(i){t=N(i,"DIV",{class:!0});var g=T(t);e=N(g,"BUTTON",{class:!0});var y=T(e);n=ne(y,"<"),y.forEach(m),r=V(g),o=N(g,"BUTTON",{class:!0});var J=T(o);c=ne(J,">"),J.forEach(m),g.forEach(m),d=V(i),a=N(i,"DIV",{});var M=T(a);X(h.$$.fragment,M),M.forEach(m),this.h()},h(){v(e,"class",l=j(s[3]>0?"active":"hidden")+" svelte-1usy634"),v(o,"class",u=j(s[1].children.length>s[3]+1?"active":"hidden")+" svelte-1usy634"),v(t,"class","navbar svelte-1usy634")},m(i,g){I(i,t,g),k(t,e),k(e,n),k(t,r),k(t,o),k(o,c),I(i,d,g),I(i,a,g),Y(h,a,null),p=!0,_||(b=[O(e,"click",s[6]),O(o,"click",s[7])],_=!0)},p(i,g){(!p||g&8&&l!==(l=j(i[3]>0?"active":"hidden")+" svelte-1usy634"))&&v(e,"class",l),(!p||g&10&&u!==(u=j(i[1].children.length>i[3]+1?"active":"hidden")+" svelte-1usy634"))&&v(o,"class",u);const y={};g&10&&(y.nodeId=i[1].children[i[3]]),h.$set(y)},i(i){p||(E(h.$$.fragment,i),p=!0)},o(i){D(h.$$.fragment,i),p=!1},d(i){i&&(m(t),m(d),m(a)),Z(h),_=!1,ae(b)}}}function Te(s){let t,e,n=s[1]&&se(s);return{c(){n&&n.c(),t=L()},l(l){n&&n.l(l),t=L()},m(l,r){n&&n.m(l,r),I(l,t,r),e=!0},p(l,[r]){l[1]?n?(n.p(l,r),r&2&&E(n,1)):(n=se(l),n.c(),E(n,1),n.m(t.parentNode,t)):n&&(ie(),D(n,1,1,()=>{n=null}),ce())},i(l){e||(E(n),e=!0)},o(l){D(n),e=!1},d(l){l&&m(t),n&&n.d(l)}}}function Ie(s,t,e){let n,l=z,r=()=>(l(),l=re(c,i=>e(1,n=i)),c);s.$$.on_destroy.push(()=>l());let{nodeId:o}=t,c=S(o);r();let u=n?n.children.length:0;var d=o;let a=0;function h(){console.log("get history");let i=[n.message],g=n.parent;for(;g!=null;){let y=S(g);i=[C(y).message,...i],g=C(y).parent}return console.log(i),i}async function p(){console.log("send");let i=h(),g=x({role:"assistant",content:""},o);x({role:"user",content:""},g);let y=S(g),J=await _e({messages:i},M=>y.update(f=>({...f,message:{...f.message,content:M}})));y.update(M=>({...M,message:{...M.message,content:J}}))}oe(()=>{c.subscribe(i=>{i.children.length>u?(e(3,a=0),console.log("child added"),u=i.children.length):i.children.length<u&&(console.log("child removed"),e(3,a=Math.max(0,a-1)),u=i.children.length)})});const _=()=>{e(3,a=Math.max(0,a-1))},b=()=>{e(3,a=Math.min(n.children.length-1,a+1))};return s.$$set=i=>{"nodeId"in i&&e(0,o=i.nodeId)},s.$$.update=()=>{s.$$.dirty&35&&o!=d&&(r(e(2,c=S(o))),e(5,d=o),u=n.children.length,e(3,a=0))},[o,n,c,a,p,d,_,b]}class de extends G{constructor(t){super(),K(this,t,Ie,Te,F,{nodeId:0})}}function Me(s){let t,e,n;return e=new de({props:{nodeId:0}}),{c(){t=w("main"),Q(e.$$.fragment),this.h()},l(l){t=N(l,"MAIN",{class:!0});var r=T(t);X(e.$$.fragment,r),r.forEach(m),this.h()},h(){v(t,"class","svelte-eolhps")},m(l,r){I(l,t,r),Y(e,t,null),n=!0},p:z,i(l){n||(E(e.$$.fragment,l),n=!0)},o(l){D(e.$$.fragment,l),n=!1},d(l){l&&m(t),Z(e)}}}class Ce extends G{constructor(t){super(),K(this,t,null,Me,F,{})}}export{Ce as component};
